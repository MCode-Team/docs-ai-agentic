# System Feature Documentation

## 1. AI Assistant Core (Ask AI)

The system revolves around a sophisticated AI assistant capable of answering questions based on documentation and database schema. It operates in two distinct modes:

### 1.1 Agentic Mode (Advanced)
A fully autonomous agent loop designed for complex problem-solving.
- **Planning & Reasoning:** break down user queries into a step-by-step plan (`lib/agent/planner.ts`).
- **Agent Loop:** Iterative execution model (`lib/agent/agent-loop.ts`) that supports:
  - **Thinking:** Internal reasoning steps visible to the user.
  - **Tool Execution:** Ability to call specific functions (Retrieval, Database access, etc.).
  - **Re-planning:** Dynamic adjustment of the plan if a step fails or new information is found.
  - **Reflection:** Summarizes interactions and updates memory after answering.
- **Human-in-the-loop:** Critical tools can require user approval. The UI (`components/ask-ai-chat.tsx`) allows users to "Approve" or "Reject" tool calls.

### 1.2 Simple Mode (Fast)
A non-agentic, direct Response-Augmented Generation (RAG) mode.
- **Workflow:** Retrieve Docs + Retrieve Dictionary -> Generate Answer.
- **Use Case:** Simple, factual questions requiring lower latency.

### 1.3 Memory System
- **Conversation History:** Maintains context of the current chat.
- **User Facts:** Extracts and stores facts about the user for personalized interactions.
- **Long-term Memory:** Persists conversation state across sessions (simulated in-memory for demo, adaptable to Redis/DB).

## 2. RAG & Retrieval Engine

### 2.1 Documentation Ingestion
- **Script:** `scripts/ingest-docs.ts`
- **Process:**
  1. Reads `.mdx` files from `content/docs`.
  2. Splits content into manageable chunks (default 900 chars).
  3. Generates embeddings using OpenAI `text-embedding-3-small`.
  4. Stores vectors + metadata in `docs_chunks` table (pgvector).

### 2.2 Data Dictionary Ingestion (Text-to-SQL helper)
- **Script:** `scripts/ingest-db-dictionary.ts`
- **Process:**
  1. Reflects on the connected PostgreSQL schema (`information_schema`).
  2. Extracts Schema, Table, Column definitions, and Comments.
  3. Constructs a natural language description for each column/table.
  4. Generates embeddings and stores in `db_dictionary_chunks`.
  5. **Benefit:** Allows the AI to understand and query the database structure semantically.

### 2.3 Search Strategy
- **Hybrid Retrieval:** Fetches candidates from both Documentation and Data Dictionary.
- **Reranking:** Uses `lib/rerank-zerank2.ts` to re-score and filter retrieved results for higher relevance before passing to the LLM.

## 3. User Interface (Ask AI Chat)

A feature-rich Chat UI built with React and Vercel AI SDK.
- **Streaming Response:** Real-time visibility of text generation.
- **Process Visualization:**
  - **"Thinking" Indicator:** Shows when the agent is planning or reasoning.
  - **Collapsed Steps:** Users can expand to see granular "Process Steps" (e.g., "Reading documents...", "Executing Tool...").
- **Citations:** Automatically links sources used in the answer:
  - **Docs:** Direct links to documentation pages.
  - **DB Dictionary:** Badges showing which tables/schemas were referenced.
- **Interactive Tooling:** UI for Pending Approvals (Approve/Reject buttons) for sensitive actions.
- **Feedback:** Thumbs Up/Down and Copy functionality.
- **Stick-to-Bottom:** Smart scrolling behavior during generation.

## 4. Tech Stack

- **Framework:** Next.js 15+ (App Router)
- **Database:** PostgreSQL with `pgvector`
- **AI SDK:** Vercel AI SDK (Core + React) & OpenAI
- **Styling:** Tailwind CSS + Lucide React Icons
- **Language:** TypeScript
